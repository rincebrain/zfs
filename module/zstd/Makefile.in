ifneq ($(KBUILD_EXTMOD),)
src = @abs_srcdir@
obj = @abs_builddir@
zstd_include = $(src)/include
else
zstd_include = $(srctree)/$(src)/include
endif

MODULE := zzstd

obj-$(CONFIG_ZFS) := $(MODULE).o

asflags-y := -I$(zstd_include)
ccflags-y := -I$(zstd_include)

# Zstd uses -O3 by default, so we should follow
ccflags-y += -O3

# -fno-tree-vectorize gets set for gcc in zstd/common/compiler.h
# Set it for other compilers, too.
%.o: c_flags += -fno-tree-vectorize

# Quiet warnings about frame size due to unused code in unmodified zstd lib
%.o: c_flags += -Wframe-larger-than=20480

# Disable aarch64 neon SIMD instructions for kernel mode
%.o: c_flags += -include $(zstd_include)/aarch64_compat.h -include $(zstd_include)/zstd_compat_wrapper.h -Wp,-w

$(obj)/zfs_zstd.o: c_flags += -include $(zstd_include)/zstd_compat_wrapper.h

$(MODULE)-objs += zfs_zstd.o
$(MODULE)-objs += zstd_sparc.o
$(MODULE)-objs += lib/common/debug.o \
		lib/common/entropy_common.o \
		lib/common/error_private.o \
		lib/common/fse_decompress.o \
		lib/common/threading.o \
		lib/common/pool.o \
		lib/common/zstd_common.o \
		lib/compress/fse_compress.o \
		lib/compress/hist.o \
		lib/compress/huf_compress.o \
		lib/compress/zstd_compress_literals.o \
		lib/compress/zstd_compress_sequences.o \
		lib/compress/zstd_compress_superblock.o \
		lib/compress/zstd_compress.o \
		lib/compress/zstd_double_fast.o \
		lib/compress/zstd_fast.o \
		lib/compress/zstd_lazy.o \
		lib/compress/zstd_ldm.o \
		lib/compress/zstd_opt.o \
		lib/compress/zstdmt_compress.o \
		lib/decompress/huf_decompress.o \
		lib/decompress/huf_decompress_amd64.o \
		lib/decompress/zstd_ddict.o \
		lib/decompress/zstd_decompress.o \
		lib/decompress/zstd_decompress_block.o

all:
	mkdir -p lib
